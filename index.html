<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DE Education - Mark Management System</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Base background color is now set by Tailwind on the <body> tag */
        }
        
        /* Custom gradient for header */
        .header-gradient {
            background: linear-gradient(to right, #1e3a8a, #3b82f6); /* Dark Blue to Blue */
        }

        /* Custom card shadow and hover effect */
        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        .card-shadow:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transform: translateY(-5px);
        }

        /* Countdown Timer Styling */
        .countdown-box {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            margin: 0 4px;
            text-align: center;
            flex: 1; /* Make boxes take equal space */
            min-width: 50px; /* Prevent shrinking too much */
        }
        .countdown-box span {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e3a8a;
            /* dark:color: #ffffff; (Handled by dark mode classes) */
        }
        .countdown-box p {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #4b5563;
            /* dark:color: #d1d5db; (Handled by dark mode classes) */
        }
        /* New: Home Page Exam Card UI */
        .exam-card-home {
            transition: all 0.3s ease-in-out;
            border-left: 5px solid #3b82f6;
        }
        .exam-card-home:hover {
            border-left-color: #1e3a8a;
        }


        /* Hide pages by default */
        .page {
            display: none;
        }
        /* Show the active page */
        .page.active {
            display: block;
            animation: fadeIn 0.7s ease-in-out; /* Page load animation */
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dark mode toggle */
        .toggle-checkbox:checked + .toggle-label .toggle-ball {
            transform: translateX(20px);
        }

        /* Preloader Style */
        .loader-gradient {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #3b82f6; /* Blue */
            border-right-color: #1e3a8a; /* Dark Blue */
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            animation: fadeIn 0.3s;
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem; /* Added padding for small screens */
        }
        .modal-content {
            margin: auto;
            padding: 24px;
            width: 90%;
            max-width: 600px;
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Print Styles */
        @media print {
            .no-print {
                display: none !important;
            }
            body, .printable-content {
                margin: 0;
                padding: 0;
                box-shadow: none;
                border: none;
            }
            .printable-content {
                width: 100%;
                max-width: 100%;
                /* border: 1px solid #000; /* Add border for PDF look */
            }
            .admission-qr-code-canvas {
                /* Ensure canvas size is appropriate for printing */
                width: 100px !important;
                height: 100px !important;
            }
        }
        
        /* Admin Navigation */
        #admin-nav a {
            transition: all 0.3s ease;
        }
        #admin-nav a.active-tab {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .admin-tab-content {
            display: none;
        }
        .admin-tab-content.active {
            display: block;
        }

        /* Message Popup Style (Bottom Center) */
        #message-popup {
            position: fixed;
            bottom: 20px; /* 5 * 4 = 20px */
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            display: flex;
            flex-direction: column-reverse; /* New messages appear at the bottom */
            align-items: center;
            gap: 0.75rem; /* 12px */
            width: 90%;
            max-width: 32rem; /* 512px */
        }
    </style>
    
    <script>
        // Set theme on initial load
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark')
        } else {
          document.documentElement.classList.remove('dark')
        }
    </script>
</head>
<body class="antialiased bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">

    <div id="preloader" class="fixed inset-0 z-[1000] flex flex-col items-center justify-center bg-gray-100 dark:bg-gray-900 transition-opacity duration-1000">
        <div class="loader-gradient w-16 h-16 animate-spin rounded-full"></div>
        <p class="mt-4 text-xl font-semibold text-gray-700 dark:text-gray-300">Loading DE Education.lk...</p>
    </div>

    <header class="header-gradient text-white p-6 shadow-md no-print sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <a href="#" onclick="event.preventDefault(); showPage('home');" class="text-3xl font-bold text-white cursor-pointer">DE Education.lk</a>
            <nav class="flex items-center gap-4">
                <a href="#" onclick="event.preventDefault(); showPage('home');" class="text-white hover:text-gray-200 px-3 py-2 rounded-md font-medium hidden sm:block">Home</a>
                <a href="#" onclick="event.preventDefault(); showPage('results');" class="text-white hover:text-gray-200 px-3 py-2 rounded-md font-medium">Check Results</a>
                
                <div class="flex items-center">
                    <input type="checkbox" class="toggle-checkbox hidden" id="dark-mode-toggle">
                    <label for="dark-mode-toggle" class="toggle-label cursor-pointer w-12 h-6 flex items-center bg-gray-300 dark:bg-gray-700 rounded-full p-1 transition-colors">
                        <div class="toggle-ball w-5 h-5 bg-white dark:bg-gray-900 rounded-full shadow-md transform transition-transform"></div>
                    </label>
                </div>
            </nav>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6 mt-8">

        <div id="page-home" class="page active">
            
            
            <h2 class="text-3xl sm:text-4xl font-extrabold text-gray-800 dark:text-gray-100 mb-8 text-center">Upcoming Exams & Registration</h2>
            
            <div class="mb-8 max-w-2xl mx-auto">
                <label for="exam-search-input" class="sr-only">Search Exams</label>
                <input type="text" id="exam-search-input" onkeyup="handleExamSearch()" 
                       class="w-full px-5 py-3 border border-gray-300 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" 
                       placeholder="Search by exam name or batch (e.g., 2025 A/L)...">
            </div>
<div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-lg mb-8" role="alert">
                <p class="font-bold">Welcome to DE Education!</p>
                <p>We are delighted to have you. You can register for upcoming exams or check your results using the navigation above.</p>
            </div>
<br>
            <div id="exams-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 sm:gap-8">
                <div class="skeleton-card p-6 rounded-xl bg-white dark:bg-gray-800 shadow-lg animate-pulse col-span-1 md:col-span-2 lg:col-span-3">
                    <div class="h-6 bg-gray-200 dark:bg-gray-700 rounded w-1/3 mb-4"></div>
                    <div class="h-8 bg-gray-300 dark:bg-gray-600 rounded w-1/2 mb-3"></div>
                    <div class="h-4 bg-gray-300 dark:bg-gray-600 rounded w-full mb-3"></div>
                    <div class="h-12 bg-gray-300 dark:bg-gray-600 rounded-lg mt-6"></div>
                </div>
            </div>
        </div>
        
        
        <div id="page-login" class="page">
            <div class="max-w-md mx-auto bg-white dark:bg-gray-800 rounded-xl card-shadow p-8">
                <h2 class="text-3xl font-bold text-center text-gray-900 dark:text-gray-100 mb-6">Admin Login</h2>
                <form id="admin-login-form">
                    <div class="mb-4">
                        <label for="username" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
                        <input type="text" id="username" name="username" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Password</label>
                        <input type="password" id="password" name="password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white text-lg font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">
                        Login
                    </button>
                </form>
            </div>
        </div>

        <div id="page-registration" class="page">
            <div class="max-w-xl mx-auto bg-white dark:bg-gray-800 rounded-xl card-shadow p-8 sm:p-10">
                <h2 class="text-3xl font-bold text-center text-gray-900 dark:text-gray-100 mb-2">Exam Registration</h2>
                <p id="reg-exam-title" class="text-center text-gray-600 dark:text-gray-300 mb-6 text-lg font-medium"></p>
                <form id="registration-form">
                    <input type="hidden" id="reg_exam_id" name="reg_exam_id">
                    
                    <div class="mb-4">
                        <label for="student_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Full Name</label>
                        <input type="text" id="student_name" name="student_name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                    </div>
                    <div class="mb-4">
                        <label for="nic" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">National ID (NIC) <span class="text-red-500">*</span></label>
                        <input type="text" id="nic" name="nic" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600" placeholder="e.g., 2005123456V or 123456789">
                    </div>
                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
                        <input type="email" id="email" name="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                    </div>
                    <div class="mb-4">
                        <label for="phone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Phone Number</label>
                        <input type="tel" id="phone" name="phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                    </div>
                    <button type="submit" id="register-submit-btn" class="w-full bg-green-600 text-white text-lg font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition duration-300">
                        Complete Registration
                    </button>
                    <button type="button" onclick="showPage('home')" class="w-full bg-gray-500 text-white text-lg font-bold py-3 px-6 rounded-lg shadow-md hover:bg-gray-600 transition duration-300 mt-3">
                        Cancel
                    </button>
                </form>
            </div>
        </div>

        <div id="page-admission" class="page">
            <h2 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-6 text-center">Your Exam Admission</h2>
            <div class="max-w-3xl mx-auto bg-white dark:bg-gray-800 rounded-xl card-shadow overflow-hidden">
                <div id="admission-content" class="printable-content p-8 sm:p-12">
                    <div class="text-center mb-8 pb-6 border-b-2 border-blue-600">
                        <h1 class="text-4xl font-extrabold text-blue-700 dark:text-blue-300">DE Education.lk</h1>
                        <p class="text-2xl font-semibold text-gray-800 dark:text-gray-100 mt-2">Exam Admission Slip</p>
                    </div>
                    
                    <div id="admission-details" class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-4">
                        </div>

                    <div class="flex justify-center mt-8">
                        <div id="admission-qr-code-container" class="border border-gray-300 p-2 rounded-lg bg-white dark:bg-gray-900">
                            </div>
                    </div>
                    
                    <div class="mt-8 pt-8 border-t border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300">
                        <h4 class="text-xl font-bold mb-4">Instructions for Candidates:</h4>
                        <ul class="list-disc list-inside space-y-2 text-sm">
                            <li>This admission slip is mandatory to enter the examination hall.</li>
                            <li>Please be present at the examination hall at least 30 minutes before the start time.</li>
                            <li>Your Index Number is your unique identifier for this exam.</li>
                            <li>Mobile phones, smartwatches, and any other electronic devices are strictly prohibited.</li>
                            <li>Please bring your National ID (NIC) or a valid photo ID for verification.</li>
                        </ul>
                    </div>
                </div>
                <div class="p-6 bg-gray-50 dark:bg-gray-700 text-center no-print">
                    <button onclick="handlePrint('admission-content', 'DE_Education_Admission')" class="bg-blue-600 text-white text-lg font-bold py-3 px-8 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">
                        Download Admission PDF
                    </button>
                    <button onclick="showPage('home')" class="bg-gray-500 text-white text-lg font-bold py-3 px-8 rounded-lg shadow-md hover:bg-gray-600 transition duration-300 mt-3 sm:mt-0 sm:ml-4">
                        Back to Home
                    </button>
                </div>
            </div>
        </div>

        <div id="page-admin" class="page">
            <h2 class="text-4xl font-extrabold text-gray-800 dark:text-gray-100 mb-3 text-center">Admin Dashboard</h2>
            <p id="admin-welcome-msg" class="text-center text-xl font-semibold text-blue-600 dark:text-blue-400 mb-8"></p>
            
            <div class="flex flex-col md:flex-row gap-6">
                <nav id="admin-nav" class="flex md:flex-col md:w-1/4 lg:w-1/5 bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 space-y-1 md:space-y-2 overflow-x-auto">
                    <a href="#" data-tab="create-exam" class="admin-nav-link active-tab flex-shrink-0 text-left px-4 py-3 font-medium rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">Create Exam</a>
                    <a href="#" data-tab="manage-exams" class="admin-nav-link flex-shrink-0 text-left px-4 py-3 font-medium rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">Manage Exams</a>
                    <a href="#" data-tab="check-in" class="admin-nav-link flex-shrink-0 text-left px-4 py-3 font-medium rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">Student Check-in</a>
                    <a href="#" data-tab="manage-marks" class="admin-nav-link flex-shrink-0 text-left px-4 py-3 font-medium rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">Manage Marks</a>
                    <a href="#" data-tab="manage-students" class="admin-nav-link flex-shrink-0 text-left px-4 py-3 font-medium rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">Manage Students</a>
                    <a href="#" data-tab="view-ranks" class="admin-nav-link flex-shrink-0 text-left px-4 py-3 font-medium rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">View Ranks</a>
                </nav>

                <div class="flex-1 md:w-3/4 lg:w-4/5">
                    
                    <div id="tab-create-exam" class="admin-tab-content active bg-white dark:bg-gray-800 rounded-xl card-shadow p-6 sm:p-8">
                        <h3 class="text-2xl font-bold mb-6">Create New Exam</h3>
                        <form id="create-exam-form">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="col-span-1 md:col-span-2">
                                    <label for="exam_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Exam Name</label>
                                    <input type="text" id="exam_name" name="name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                                </div>
                                <div>
                                    <label for="exam_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Exam Date</label>
                                    <input type="date" id="exam_date" name="exam_date" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                                </div>
                                <div>
                                    <label for="exam_time" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Exam Time</label>
                                    <input type="time" id="exam_time" name="exam_time" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                                </div>
                                <div>
                                    <label for="reg_start_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Registration Start</label>
                                    <input type="datetime-local" id="reg_start_date" name="reg_start_date" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                                </div>
                                <div>
                                    <label for="reg_end_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Registration End</label>
                                    <input type="datetime-local" id="reg_end_date" name="reg_end_date" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                                </div>
                                <div class="col-span-1 md:col-span-2">
                                    <label for="batch_year" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Batch (e.g., 2025 A/L)</label>
                                    <input type="text" id="batch_year" name="batch_year" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                                </div>
                            </div>
                            <button type="submit" class="w-full mt-6 bg-blue-600 text-white text-lg font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">
                                Create Exam
                            </button>
                        </form>
                    </div>

                    <div id="tab-manage-exams" class="admin-tab-content bg-white dark:bg-gray-800 rounded-xl card-shadow p-6 sm:p-8">
                        <h3 class="text-2xl font-bold mb-6">Manage Existing Exams</h3>
                        <div id="manage-exams-list" class="overflow-x-auto">
                            <p class="text-gray-600 dark:text-gray-400">Loading exams...</p>
                        </div>
                    </div>

                    <div id="tab-check-in" class="admin-tab-content bg-white dark:bg-gray-800 rounded-xl card-shadow p-6 sm:p-8">
                        <h3 class="text-2xl font-bold mb-6">Student Exam Check-in (Attendance)</h3>
                        <div class="mb-4">
                            <label for="check-in-exam-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select Exam</label>
                            <select id="check-in-exam-select" name="check-in-exam-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                                <option value="">-- Select an Exam --</option>
                            </select>
                        </div>

                        <div class="text-center bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg mb-4 dark:bg-yellow-900 dark:text-yellow-200" role="alert">
                            <p class="font-bold">Important:</p>
                            <p>Attendance can be marked by Index Number or by scanning the QR code on the Admission Slip (Scanner not fully functional in this mockup).</p>
                        </div>

                        <form id="check-in-form">
                            <div class="mb-4">
                                <label for="check_in_index_number" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Enter Index Number or Scan QR</label>
                                <input type="text" id="check_in_index_number" name="check_in_index_number" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600" placeholder="DE-1-1001 or Scan">
                            </div>
                            <button type="submit" id="check-in-submit-btn" class="w-full mt-4 bg-purple-600 text-white text-lg font-bold py-3 px-6 rounded-lg shadow-md hover:bg-purple-700 transition duration-300">
                                Mark as Present / Check-in
                            </button>
                        </form>
                        <div id="check-in-status" class="mt-6 p-4 rounded-lg text-center font-medium hidden"></div>
                    </div>
                    
                    <div id="tab-manage-marks" class="admin-tab-content bg-white dark:bg-gray-800 rounded-xl card-shadow p-6 sm:p-8">
                        <h3 class="text-2xl font-bold mb-6">Add / Update Student Marks</h3>
                        <div class="mb-4">
                            <label for="mark-exam-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select Exam</label>
                            <select id="mark-exam-select" name="mark-exam-select" onchange="loadStudentsForMarking(this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                                <option value="">-- Select an Exam --</option>
                            </select>
                        </div>

                        <form id="add-mark-form">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                <div>
                                    <label for="index_number" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Index Number</label>
                                    <input type="text" id="index_number" name="index_number" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                                </div>
                                <div>
                                    <label for="marks" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Marks (e.g., 76.53)</label>
                                    <input type="number" step="0.01" id="marks" name="marks" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                                </div>
                                <div class="flex items-center justify-start h-full pb-2">
                                    <input type="checkbox" id="absent" name="absent" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <label for="absent" class="ml-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Mark as Absent</label>
                                </div>
                            </div>
                            <button type="submit" class="w-full mt-4 bg-green-600 text-white text-lg font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition duration-300">
                                Add / Update Mark
                            </button>
                        </form>
                        
                        <div id="mark-student-list" class="mt-8 overflow-x-auto">
                            </div>
                    </div>
                    
                    <div id="tab-manage-students" class="admin-tab-content bg-white dark:bg-gray-800 rounded-xl card-shadow p-6 sm:p-8">
                        <h3 class="text-2xl font-bold mb-6">Manage Student Registrations</h3>
                        <div class="mb-4">
                            <label for="student-exam-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select Exam</label>
                            <select id="student-exam-select" name="student-exam-select" onchange="loadStudentsForManagement(this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                                <option value="">-- Select an Exam --</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <input type="text" id="student-search-input" onkeyup="handleStudentSearch()" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600" placeholder="Search by name, NIC, email, or index...">
                        </div>
                        <div id="student-management-list" class="overflow-x-auto">
                            <p class="text-gray-600 dark:text-gray-400">Select an exam to see registered students.</p>
                        </div>
                    </div>

                    <div id="tab-view-ranks" class="admin-tab-content bg-white dark:bg-gray-800 rounded-xl card-shadow p-6 sm:p-8">
                        <h3 class="text-2xl font-bold mb-6">View Exam Ranks & Leaderboards</h3>
                        <div class="mb-4">
                            <label for="rank-exam-select-admin" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select Exam</label>
                            <select id="rank-exam-select-admin" name="rank-exam-select-admin" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                                <option value="">-- Select an Exam --</option>
                            </select>
                        </div>
                        <div class="flex gap-4">
                            <button onclick="handleViewLeaderboard('top10', 'admin')" class="flex-1 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">
                                View Top 10
                            </button>
                            <button onclick="handleViewLeaderboard('all', 'admin')" class="flex-1 bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-gray-700 transition duration-300">
                                View All Ranks
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div id="page-results" class="page">
            <div class="max-w-2xl mx-auto">
                <div class="bg-white dark:bg-gray-800 rounded-xl card-shadow p-8 sm:p-10 mb-8">
                    <h2 class="text-3xl font-bold text-center text-gray-900 dark:text-gray-100 mb-6">Check Your Exam Results</h2>
                    <form id="check-result-form">
                        <div class="mb-4">
                            <label for="result-exam-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select Exam</label>
                            <select id="result-exam-select" name="result-exam-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                                <option value="">-- Select an Exam --</option>
                                </select>
                        </div>
                        <div class="mb-4">
                            <label for="result-index-number" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Your Index Number</label>
                            <input type="text" id="result-index-number" name="result-index-number" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600" placeholder="e.g., DE-1-1001">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white text-lg font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">
                            Check Result
                        </button>
                    </form>
                    
                    <div class="mt-4">
                        <button onclick="handleViewLeaderboard('top10', 'public')" class="w-full bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-300">
                            View Top 10
                        </button>
                    </div>
                </div>
                
                <div id="result-display-wrapper">
                    </div>
            </div>
        </div>
        
        <div id="result-pdf-template" class="hidden">
            <div class="bg-white dark:bg-gray-800 rounded-xl card-shadow overflow-hidden">
                <div id="result-content" class="printable-content p-8 sm:p-12">
                    <div class="text-center mb-8 pb-6 border-b-2 border-blue-600">
                        <h1 class="text-4xl font-extrabold text-blue-700 dark:text-blue-300">DE Education.lk</h1>
                        <p class="text-2xl font-semibold text-gray-800 dark:text-gray-100 mt-2">Official Result Slip</p>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-4 mb-8">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-600 dark:text-gray-400">Exam Details</h3>
                            <p class="text-lg"><strong class="font-medium text-gray-900 dark:text-gray-100">Exam:</strong> <span id="pdf-exam-name"></span></p>
                            <p class="text-lg"><strong class="font-medium text-gray-900 dark:text-gray-100">Date:</strong> <span id="pdf-exam-date"></span></p>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-600 dark:text-gray-400">Student Details</h3>
                            <p class="text-lg"><strong class="font-medium text-gray-900 dark:text-gray-100">Name:</strong> <span id="pdf-student-name"></span></p>
                            <p class="text-lg"><strong class="font-medium text-gray-900 dark:text-gray-100">Index No:</strong> <span id="pdf-index-number"></span></p>
                        </div>
                    </div>
                    
                    <div class="text-center bg-gray-50 dark:bg-gray-700 rounded-lg p-8">
                        <p class="text-lg font-medium text-gray-600 dark:text-gray-300">Your Result</p>
                        <p id="pdf-marks" class="text-7xl font-extrabold text-blue-600 dark:text-blue-400 my-2"></p>
                        <p id="pdf-grade" class="text-5xl font-bold text-gray-800 dark:text-gray-100"></p>
                        <p id="pdf-rank" class="text-2xl font-semibold text-gray-700 dark:text-gray-200 mt-4"></p>
                    </div>
                </div>
                <div class="p-6 bg-gray-50 dark:bg-gray-700 text-center no-print">
                    <button onclick="handlePrint('result-content', 'DE_Education_Result')" class="bg-blue-600 text-white text-lg font-bold py-3 px-8 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">
                        Download Result PDF
                    </button>
                </div>
            </div>
        </div>

    </main>

    <footer class="text-center p-8 mt-12 bg-gray-800 text-gray-400 no-print">
        <div class="container mx-auto grid grid-cols-1 md:grid-cols-3 gap-6 text-sm">
            <div>
                <h5 class="font-bold text-white text-base mb-2">About Us</h5>
                <p>DE Education.lk is a premier platform for managing student results and exam registrations efficiently.</p>
            </div>
            <div>
                <h5 class="font-bold text-white text-base mb-2">Contact</h5>
                <p>Email: <a href="mailto:email.in.fo.dilnuka@outlook.com" class="hover:text-white transition-colors">email.in.fo.dilnuka@outlook.com</a></p>
                <p>Phone: <a href="tel:0764164804" class="hover:text-white transition-colors">0764164804</a></p>
            </div>
            <div>
                <h5 class="font-bold text-white text-base mb-2">Links</h5>
                <p><a href="https://dilnuka13.github.io/my/" target="_blank" rel="noopener noreferrer" class="hover:text-white transition-colors">Creator Page</a></p>
                <p><a href="#" onclick="event.preventDefault(); showPage('login');" class="hover:text-white transition-colors">Admin Panel</a></p>
            </div>
        </div>
        <p class="mt-8 border-t border-gray-700 pt-6 text-xs">
            <a href="https://dilnuka13.github.io/AL/" target="_blank" rel="noopener noreferrer" class="hover:text-white transition-colors">&copy; 2025 DE Education.lk</a> | All Rights Reserved.
        </p>
    </footer>

    <div id="message-popup" class="fixed bottom-5 left-1/2 -translate-x-1/2 z-[1001] flex flex-col-reverse items-center gap-3 w-11/12 max-w-lg">
        </div>
    
    <div id="edit-student-modal" class="modal">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl">
            <h3 class="text-2xl font-bold mb-6 text-gray-900 dark:text-gray-100">Edit Student Information</h3>
            <form id="edit-student-form">
                <input type="hidden" id="edit-student-id">
                <div class="mb-4">
                    <label for="edit_student_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Full Name</label>
                    <input type="text" id="edit_student_name" name="edit_student_name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div class="mb-4">
                    <label for="edit_nic" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">National ID (NIC)</label>
                    <input type="text" id="edit_nic" name="edit_nic" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div class="mb-4">
                    <label for="edit_email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
                    <input type="email" id="edit_email" name="edit_email" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div class="mb-4">
                    <label for="edit_phone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Phone Number</label>
                    <input type="tel" id="edit_phone" name="edit_phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" onclick="closeEditStudentModal()" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-gray-600 transition duration-300">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">Update Student</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-exam-modal" class="modal">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl">
            <h3 class="text-2xl font-bold mb-6 text-gray-900 dark:text-gray-100">Edit Exam</h3>
            <form id="edit-exam-form">
                <input type="hidden" id="edit-exam-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="col-span-1 md:col-span-2">
                        <label for="edit_exam_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Exam Name</label>
                        <input type="text" id="edit_exam_name" name="name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                    </div>
                    <div>
                        <label for="edit_exam_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Exam Date</label>
                        <input type="date" id="edit_exam_date" name="exam_date" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                    </div>
                    <div>
                        <label for="edit_exam_time" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Exam Time</label>
                        <input type="time" id="edit_exam_time" name="exam_time" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                    </div>
                    <div>
                        <label for="edit_reg_start_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Registration Start</label>
                        <input type="datetime-local" id="edit_reg_start_date" name="reg_start_date" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                    </div>
                    <div>
                        <label for="edit_reg_end_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Registration End</label>
                        <input type="datetime-local" id="edit_reg_end_date" name="reg_end_date" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                    </div>
                    <div class="col-span-1 md:col-span-2">
                        <label for="edit_batch_year" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Batch</label>
                        <input type="text" id="edit_batch_year" name="batch_year" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" onclick="closeEditExamModal()" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-gray-600 transition duration-300">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">Update Exam</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="leaderboard-modal" class="modal">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-3xl">
            <div class="flex justify-between items-center mb-4">
                <h3 id="leaderboard-title" class="text-2xl font-bold text-gray-900 dark:text-gray-100">Exam Leaderboard</h3>
                <button onclick="closeLeaderboardModal()" class="text-gray-500 dark:text-gray-400 hover:text-red-500 dark:hover:text-red-400 text-3xl font-bold">&times;</button>
            </div>
            <div id="leaderboard-content" class="overflow-y-auto max-h-[70vh]">
                </div>
            <div class="text-right mt-6 no-print">
                <button id="download-leaderboard-pdf" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">
                    Download as PDF
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        const SUPABASE_URL = 'https://lnmxgbpwbdlndxwlchsy.supabase.co';
        // Corrected API Key
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxubXhnYnB3YmRsbmR4d2xjaHN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNzcyMjcsImV4cCI6MjA3Nzg1MzIyN30.IUmxduQrYkh-IERdvz1sIFhfxSx7i0X93HilVbBqHyE';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global state
        let currentExamData = {}; // To store loaded exams
        let currentStudentData = []; // To store students for management
        let currentMarkData = []; // To store marks for management
        
        // --- Core Functions ---

        /**
         * Shows a page and hides others
         * @param {string} pageId - The ID of the page to show
         */
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            const pageToShow = document.getElementById(`page-${pageId}`);
            if (pageToShow) {
                pageToShow.classList.add('active');
                window.scrollTo(0, 0); // Scroll to top on page change
            }
            
            // Special actions when showing admin page
            if (pageId === 'admin') {
                loadAdminData();
                showAdminTab('create-exam'); // Default to create exam tab
                // Set welcome message
                const adminName = sessionStorage.getItem('adminName') || 'Admin';
                document.getElementById('admin-welcome-msg').innerText = `Welcome, ${adminName}.`;
            } else {
                 sessionStorage.removeItem('adminName'); // Clear admin session on navigation away
            }
            // Special actions when showing results page
            if (pageId === 'results') {
                loadPublishedExams();
            }
            // Special actions when showing home page
            if (pageId === 'home') {
                loadExams();
            }
            // Special actions for check-in page
            if (pageId === 'check-in') {
                loadCheckInExams();
            }
        }
        window.showPage = showPage; // Make globally accessible

        /**
         * Shows a message popup
         * @param {string} message - The message to display
         * @param {string} type - 'success' or 'error'
         */
        function showMessage(message, type = 'success') {
            const popupContainer = document.getElementById('message-popup');
            const msgId = `msg-${Date.now()}`;
            
            const bgColor = type === 'success' ? 'bg-green-600' : 'bg-red-600';
            const textColor = 'text-white';
            
            const messageElement = document.createElement('div');
            messageElement.id = msgId;
            // Updated classes for bottom-center animation
            messageElement.className = `${bgColor} ${textColor} p-4 rounded-lg shadow-lg opacity-0 transform translate-y-10 transition-all duration-500 ease-out`;
            messageElement.innerText = message;
            
            popupContainer.appendChild(messageElement);
            
            // Animate in
            setTimeout(() => {
                messageElement.style.opacity = '1';
                messageElement.style.transform = 'translateY(0)';
            }, 10);
            
            // Auto-dismiss
            setTimeout(() => {
                if (messageElement) {
                    messageElement.style.opacity = '0';
                    messageElement.style.transform = 'translateY(10px)'; // Fade out upwards slightly
                    setTimeout(() => messageElement.remove(), 500);
                }
            }, 5000);
        }
        window.showMessage = showMessage;

        /**
         * Formats a datetime-local string from Supabase for HTML input
         * @param {string} isoString - The ISO string from Supabase
         * @returns {string} - Formatted string for <input type="datetime-local">
         */
        function formatDateTimeForInput(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            date.setMinutes(date.getMinutes() - date.getTimezoneOffset()); // Adjust for local timezone
            return date.toISOString().slice(0, 16);
        }

        /**
         * Formats a date string from Supabase for HTML input
         * @param {string} isoString - The ISO string from Supabase
         * @returns {string} - Formatted string for <input type="date">
         */
        function formatDateForInput(isoString) {
            if (!isoString) return '';
            return isoString.split('T')[0];
        }

        /**
         * Handles printing for Admission and Result slips
         * @param {string} contentId - ID of the element to print
         * @param {string} filename - Desired filename for the PDF
         */
        function handlePrint(contentId, filename) {
            const { jsPDF } = window.jspdf;
            const content = document.getElementById(contentId);
            if (!content) return;

            // Clone the content to modify styles for PDF
            const contentClone = content.cloneNode(true);
            
            // Force dark mode styles to be light for PDF consistency
            contentClone.querySelectorAll('*').forEach(el => {
                // Ensure text is visible in PDF by forcing black/dark grey
                el.classList.remove('dark:bg-gray-800', 'dark:text-gray-100', 'dark:text-gray-300', 'dark:text-blue-300', 'dark:border-gray-600', 'dark:bg-gray-700', 'dark:text-gray-200', 'dark:text-blue-400');
                
                // Force light mode styles
                el.style.color = '#111827'; // Default text
                if (el.tagName === 'H1') el.style.color = '#1d4ed8'; // blue-700
                if (el.classList.contains('text-gray-800')) el.style.color = '#1f2937';
                if (el.classList.contains('text-gray-700')) el.style.color = '#374151';
                if (el.classList.contains('text-gray-600')) el.style.color = '#4b5563';
                if (el.classList.contains('text-gray-900')) el.style.color = '#111827';
                
                // Specific for result PDF
                if (el.id === 'pdf-marks') el.style.color = '#2563eb'; // blue-600
                if (el.id === 'pdf-rank') el.style.color = '#374151';

                // Handle QR Code canvas: convert to image data URL for PDF
                if (el.id === 'admission-qr-code-container') {
                    const canvas = el.querySelector('canvas');
                    if (canvas) {
                        const imgData = canvas.toDataURL('image/png');
                        const img = document.createElement('img');
                        img.src = imgData;
                        img.width = canvas.width;
                        img.height = canvas.height;
                        el.innerHTML = '';
                        el.appendChild(img);
                    }
                }

            });
            contentClone.style.backgroundColor = '#ffffff';
            contentClone.style.color = '#111827';
            
            // A4 size: 210mm wide. We'll use 190mm for content with 10mm margins
            const doc = new jsPDF({
                orientation: 'p',
                unit: 'mm',
                format: 'a4'
            });

            // Use html2canvas for complex content like QR codes
            doc.html(contentClone, {
                callback: function (doc) {
                    doc.save(`${filename}.pdf`);
                },
                x: 10,
                y: 10,
                width: 190,
                windowWidth: 800 // Assume a reasonable width for scaling
            });
        }
        window.handlePrint = handlePrint;

        /**
         * Generates and displays a QR code
         * @param {string} text - The text to encode (student index number)
         * @param {string} elementId - The ID of the container element
         */
        function generateQRCode(text, elementId) {
            const container = document.getElementById(elementId);
            container.innerHTML = ''; // Clear previous QR
            window.QRCode.toCanvas(container, text, {
                width: 120, // Small size for admission slip
                color: {
                    dark: '#000000',
                    light: '#ffffff'
                }
            }, function (error) {
                if (error) console.error(error);
            });
        }
        window.generateQRCode = generateQRCode;

        // --- Dark Mode ---
        
        /**
         * Toggles dark mode class on <html> and saves to localStorage
         */
        function toggleDarkMode() {
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            if (darkModeToggle.checked) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            }
        }
        
        // --- Home Page (index.html) ---

        /**
         * Loads all exams for the home page
         */
        async function loadExams() {
            const container = document.getElementById('exams-container');
            container.innerHTML = `
                <div class="skeleton-card p-6 rounded-xl bg-white dark:bg-gray-800 shadow-lg animate-pulse col-span-1 md:col-span-2 lg:col-span-3">
                    <div class="h-6 bg-gray-200 dark:bg-gray-700 rounded w-1/3 mb-4"></div>
                    <div class="h-8 bg-gray-300 dark:bg-gray-600 rounded w-1/2 mb-3"></div>
                    <div class="h-4 bg-gray-300 dark:bg-gray-600 rounded w-full mb-3"></div>
                    <div class="h-12 bg-gray-300 dark:bg-gray-600 rounded-lg mt-6"></div>
                </div>`;
            
            try {
                const { data: exams, error } = await supabase
                    .from('exams')
                    .select('*')
                    .order('reg_end_date', { ascending: true }); // Order by registration end date

                if (error) throw error;

                // Store exams in global state
                currentExamData = {};
                exams.forEach(exam => {
                    currentExamData[exam.id] = exam;
                });

                if (exams.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-600 dark:text-gray-400 col-span-full">No exams are scheduled at this time.</p>';
                    return;
                }
                
                // Display the exams
                displayExams(exams);

            } catch (error) {
                console.error('Error loading exams:', error.message);
                container.innerHTML = `<p class="text-center text-red-600 col-span-full">Error loading exams. Please try again later.</p>`;
            }
        }
        
        /**
         * Renders exams on the home page
         * @param {Array} exams - Array of exam objects to display
         */
        function displayExams(exams) {
            const container = document.getElementById('exams-container');
            container.innerHTML = ''; // Clear
            
            if (exams.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-600 dark:text-gray-400 col-span-full">No exams match your search.</p>';
                return;
            }

            const now = new Date();
            exams.forEach(exam => {
                const regStart = new Date(exam.reg_start_date);
                const regEnd = new Date(exam.reg_end_date);
                
                // Only show exams where reg is still open or has been open in the recent past (for visibility)
                if (regEnd < now && (now.getTime() - regEnd.getTime()) > (30 * 24 * 60 * 60 * 1000)) { // Hide exams closed for more than 30 days
                    return;
                }

                const examCard = document.createElement('div');
                examCard.className = 'bg-white dark:bg-gray-800 rounded-xl card-shadow p-6 flex flex-col justify-between transition-transform transform exam-card-home'; 

                let content = `
                    <div>
                        <span class="inline-block bg-blue-100 text-blue-800 text-sm font-semibold px-3 py-1 rounded-full mb-3 dark:bg-blue-900 dark:text-blue-200">${exam.batch_year}</span>
                        <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-2">${exam.name}</h3>
                        <p class="text-gray-600 dark:text-gray-300 mb-1"><span class="font-semibold">Exam Date:</span> ${new Date(exam.exam_date).toLocaleDateString('en-US')} | ${exam.exam_time}</p>
                        <p class="text-gray-600 dark:text-gray-300 mb-4 text-sm"><span class="font-semibold">Registration:</span> ${regStart.toLocaleDateString('en-US')} to ${regEnd.toLocaleDateString('en-US')}</p>
                    </div>
                    <div class="mt-4 text-center" id="action-area-${exam.id}">
                        </div>
                `;
                examCard.innerHTML = content;
                container.appendChild(examCard);

                const actionArea = document.getElementById(`action-area-${exam.id}`);

                if (now < regStart) {
                    actionArea.innerHTML = `
                        <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Registration opens in:</p>
                        <div id="countdown-${exam.id}" class="flex justify-center items-center gap-1 text-center"></div>
                    `;
                    startCountdown(`countdown-${exam.id}`, regStart, exam.id);
                } else if (now >= regStart && now <= regEnd) {
                    actionArea.innerHTML = `
                        <button onclick="prepareRegistration(${exam.id})" class="inline-block w-full bg-green-600 text-white text-lg font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition duration-300">
                            Register Now
                        </button>
                    `;
                } else {
                    actionArea.innerHTML = `<div class="bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300 text-lg font-bold py-3 px-6 rounded-lg">Registration Closed</div>`;
                }
            });
            
            // If the filter caused the container to be empty, show the "no exams" message.
            if (container.innerHTML === '') {
                container.innerHTML = '<p class="text-center text-gray-600 dark:text-gray-400 col-span-full">No exams match your search or have recent open registrations.</p>';
            }
        }
        
        /**
         * Handles searching exams on the home page
         */
        function handleExamSearch() {
            const query = document.getElementById('exam-search-input').value.toLowerCase();
            const allExams = Object.values(currentExamData);
            
            const filteredExams = allExams.filter(exam => {
                return (
                    exam.name.toLowerCase().includes(query) ||
                    exam.batch_year.toLowerCase().includes(query)
                );
            });
            
            displayExams(filteredExams); // Call the display function with filtered results
        }
        window.handleExamSearch = handleExamSearch;

        /**
         * Starts a countdown timer
         * @param {string} elementId - ID of the container element
         * @param {Date} targetDate - The date to count down to
         * @param {number} examId - The ID of the exam for re-rendering logic
         */
        function startCountdown(elementId, targetDate, examId) {
            const countdownElement = document.getElementById(elementId);
            if (!countdownElement) return;

            const interval = setInterval(() => {
                const now = new Date().getTime();
                const distance = targetDate.getTime() - now; // Use getTime()

                if (distance < 0) {
                    clearInterval(interval);
                    // Check if action-area exists before modifying
                    const actionArea = document.getElementById(`action-area-${examId}`);
                    if (actionArea) {
                         actionArea.innerHTML = `
                            <button onclick="prepareRegistration(${examId})" class="inline-block w-full bg-green-600 text-white text-lg font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition duration-300">
                                Register Now
                            </button>
                        `;
                    }
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                countdownElement.innerHTML = `
                    <div class="countdown-box"><span class="dark:text-white">${days}</span><p class="dark:text-gray-300">Days</p></div>
                    <div class="countdown-box"><span class="dark:text-white">${hours}</span><p class="dark:text-gray-300">Hours</p></div>
                    <div class="countdown-box"><span class="dark:text-white">${minutes}</span><p class="dark:text-gray-300">Mins</p></div>
                    <div class="countdown-box"><span class="dark:text-white">${seconds}</span><p class="dark:text-gray-300">Secs</p></div>
                `;
            }, 1000);
        }

        // --- Registration Page (registration.html) ---

        /**
         * Prepares the registration form with exam details and pre-fills student info
         * @param {number} examId - The ID of the selected exam
         */
        function prepareRegistration(examId) {
            const exam = currentExamData[examId];
            if (!exam) {
                showMessage('Could not find exam details. Please try again.', 'error');
                return;
            }
            
            document.getElementById('registration-form').reset();
            document.getElementById('reg_exam_id').value = exam.id;
            document.getElementById('reg-exam-title').innerText = `For ${exam.name} (${exam.batch_year})`;

            // Personalization: Pre-fill student data
            document.getElementById('student_name').value = 'Isara Dilnuka';
            // Placeholder NIC, as the actual one is sensitive and should not be stored in client-side code normally
            document.getElementById('nic').value = '2005123456V'; 
            document.getElementById('email').value = 'email.in.fo.dilnuka@outlook.com';
            document.getElementById('phone').value = '0764164804';
            
            showPage('registration');
        }
        window.prepareRegistration = prepareRegistration;
        
        /**
         * Handles the registration form submission
         * @param {Event} e - The form submit event
         */
        async function handleRegistrationSubmit(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('register-submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerText = 'Registering...';

            const form = e.target;
            const formData = new FormData(form);
            const studentData = Object.fromEntries(formData.entries());
            
            const examId = parseInt(studentData.reg_exam_id);
            if (!examId) {
                showMessage('Exam ID is missing. Please go back and select an exam.', 'error');
                submitBtn.disabled = false;
                submitBtn.innerText = 'Complete Registration';
                return;
            }

            try {
                // 1. Check if NIC already registered for this exam
                const { data: existingReg, error: checkError } = await supabase
                    .from('registrations')
                    .select('id')
                    .eq('exam_id', examId)
                    .eq('nic', studentData.nic)
                    .maybeSingle(); // Use maybeSingle to get null instead of error on no rows

                if (checkError && checkError.code !== 'PGRST116') { // PGRST116 = no rows found
                    throw checkError;
                }
                
                if (existingReg) {
                    throw new Error('This NIC is already registered for this exam.');
                }

                // 2. Get the count of existing registrations for this exam to generate index number
                const { count, error: countError } = await supabase
                    .from('registrations')
                    .select('*', { count: 'exact', head: true })
                    .eq('exam_id', examId);
                
                if (countError) throw countError;
                
                // Generate a unique, sequential index number (e.g., DE-1-1001)
                const nextId = (count || 0) + 1001; // Start from 1001
                const indexNumber = `DE-${examId}-${nextId}`;
                
                // 3. Insert new registration
                const { data: newRegistration, error: insertError } = await supabase
                    .from('registrations')
                    .insert({
                        exam_id: examId,
                        student_name: studentData.student_name,
                        nic: studentData.nic,
                        email: studentData.email,
                        phone: studentData.phone,
                        index_number: indexNumber,
                        is_present: false // NEW: Default to not present
                    })
                    .select()
                    .single();

                if (insertError) throw insertError;

                showMessage('Registration successful! Your Index Number is: ' + indexNumber, 'success');
                form.reset();
                
                // 4. Show admission slip
                showAdmission(newRegistration, currentExamData[examId]);

            } catch (error) {
                console.error('Registration error:', error.message);
                showMessage(`Registration failed: ${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerText = 'Complete Registration';
            }
        }

        // --- Admission Page (admissionpdf.html) ---
        
        /**
         * Displays the admission slip page
         * @param {object} registrationData - The student's registration details
         * @param {object} examData - The details of the exam
         */
        function showAdmission(registrationData, examData) {
            const detailsContainer = document.getElementById('admission-details');
            detailsContainer.innerHTML = `
                <div>
                    <h3 class="text-lg font-semibold text-gray-600 dark:text-gray-400">Student Details</h3>
                    <p class="text-lg"><strong class="font-medium text-gray-900 dark:text-gray-100">Name:</strong> ${registrationData.student_name}</p>
                    <p class="text-lg"><strong class="font-medium text-gray-900 dark:text-gray-100">NIC:</strong> ${registrationData.nic}</p>
                    <p class="text-lg"><strong class="font-medium text-gray-900 dark:text-gray-100">Phone:</strong> ${registrationData.phone || 'N/A'}</p>
                    <p class="text-lg"><strong class="font-medium text-gray-900 dark:text-gray-100">Email:</strong> ${registrationData.email || 'N/A'}</p>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-600 dark:text-gray-400">Exam Details</h3>
                    <p class="text-lg"><strong class="font-medium text-gray-900 dark:text-gray-100">Exam:</strong> ${examData.name} (${examData.batch_year})</p>
                    <p class="text-lg"><strong class="font-medium text-gray-900 dark:text-gray-100">Date:</strong> ${new Date(examData.exam_date).toLocaleDateString('en-US')}</p>
                    <p class="text-lg"><strong class="font-medium text-gray-900 dark:text-gray-100">Time:</strong> ${examData.exam_time}</p>
                    <p class="text-2xl font-bold text-red-600 dark:text-red-400 mt-2">
                        <strong class="font-medium text-gray-900 dark:text-gray-100">Index No:</strong> ${registrationData.index_number}
                    </p>
                </div>
            `;
            
            // Generate QR code for the index number
            generateQRCode(registrationData.index_number, 'admission-qr-code-container');

            showPage('admission');
        }

        // --- Admin: Login ---
        
        /**
         * Handles the static admin login
         * @param {Event} e - The form submit event
         */
        function handleAdminLogin(e) {
            e.preventDefault();
            const username = e.target.username.value;
            const password = e.target.password.value;
            
            // Static credentials
            if (username === 'isaradilnuka2005@gmail.com' && password === '20052005') {
                sessionStorage.setItem('adminName', 'Isara Dilnuka'); // Store name for welcome message
                showMessage('Login Successful!', 'success');
                showPage('admin');
            } else {
                showMessage('Invalid username or password', 'error');
            }
        }

        // --- Admin: Core ---

        /**
         * Switches between admin tabs
         * @param {string} tabId - The ID of the tab to show
         */
        function showAdminTab(tabId) {
            // Update content
            document.querySelectorAll('.admin-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`tab-${tabId}`).classList.add('active');
            
            // Update nav link
            document.querySelectorAll('.admin-nav-link').forEach(link => {
                link.classList.remove('active-tab');
                if (link.dataset.tab === tabId) {
                    link.classList.add('active-tab');
                }
            });
        }

        /**
         * Loads all necessary data for the admin dashboard
         */
        async function loadAdminData() {
            try {
                const { data: exams, error } = await supabase
                    .from('exams')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                
                // Store in global state for other functions
                currentExamData = {};
                exams.forEach(exam => {
                    currentExamData[exam.id] = exam;
                });

                // Populate all exam dropdowns
                const selects = [
                    document.getElementById('mark-exam-select'),
                    document.getElementById('student-exam-select'),
                    document.getElementById('rank-exam-select-admin'),
                    document.getElementById('check-in-exam-select') // NEW: Check-in select
                ];
                
                selects.forEach(select => {
                    select.innerHTML = '<option value="">-- Select an Exam --</option>'; // Reset
                    exams.forEach(exam => {
                        select.innerHTML += `<option value="${exam.id}">${exam.name} (${exam.batch_year})</option>`;
                    });
                });
                
                // Populate the "Manage Exams" list
                populateManageExamsList(exams);

            } catch (error) {
                console.error('Error loading admin data:', error.message);
                showMessage('Could not load admin data: ' + error.message, 'error');
            }
        }

        // --- Admin: Create Exam ---
        
        /**
         * Handles the create exam form submission
         * @param {Event} e - The form submit event
         */
        async function handleCreateExamSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const examData = Object.fromEntries(formData.entries());
            
            try {
                const { error } = await supabase
                    .from('exams')
                    .insert(examData);
                
                if (error) throw error;
                
                showMessage('Exam created successfully!', 'success');
                form.reset();
                loadAdminData(); // Refresh all admin data
                loadExams(); // Refresh home page exams
            } catch (error) {
                console.error('Error creating exam:', error.message);
                showMessage('Error creating exam: ' + error.message, 'error');
            }
        }
        
        // --- Admin: Manage Exams ---
        
        /**
         * Populates the "Manage Exams" tab with a table of exams
         * @param {Array} exams - Array of exam objects
         */
        function populateManageExamsList(exams) {
            const container = document.getElementById('manage-exams-list');
            if (exams.length === 0) {
                container.innerHTML = '<p class="text-gray-600 dark:text-gray-400">No exams found. Create one!</p>';
                return;
            }
            
            let tableHTML = `
                <table class="w-full min-w-max text-left">
                    <thead class="bg-gray-100 dark:bg-gray-700">
                        <tr>
                            <th class="p-3 font-semibold">Name</th>
                            <th class="p-3 font-semibold">Date</th>
                            <th class="p-3 font-semibold">Published</th>
                            <th class="p-3 font-semibold">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            exams.forEach(exam => {
                tableHTML += `
                    <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                        <td class="p-3">${exam.name} (${exam.batch_year})</td>
                        <td class="p-3">${new Date(exam.exam_date).toLocaleDateString()}</td>
                        <td class="p-3">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${
                                exam.is_published
                                ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200'
                                : 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200'
                            }">
                                ${exam.is_published ? 'Published' : 'Pending'}
                            </span>
                        </td>
                        <td class="p-3 flex gap-2 flex-wrap"> <button onclick="openEditExamModal(${exam.id})" class="text-sm bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md shadow-sm">Edit</button>
                            <button onclick="handlePublishResults(${exam.id})" class="text-sm bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-md shadow-sm">${exam.is_published ? 'Republish' : 'Publish'}</button>
                            ${exam.is_published ? `<button onclick="handleUnpublishResults(${exam.id})" class="text-sm bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded-md shadow-sm">Unpublish</button>` : ''}
                            <button onclick="handleDeleteExam(${exam.id})" class="text-sm bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md shadow-sm">Delete</button>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
        }

        /**
         * Opens the edit exam modal and pre-fills it
         * @param {number} examId - The ID of the exam to edit
         */
        async function openEditExamModal(examId) {
            try {
                const { data: exam, error } = await supabase
                    .from('exams')
                    .select('*')
                    .eq('id', examId)
                    .single();
                
                if (error) throw error;
                
                document.getElementById('edit-exam-id').value = exam.id;
                document.getElementById('edit_exam_name').value = exam.name;
                document.getElementById('edit_exam_date').value = formatDateForInput(exam.exam_date);
                document.getElementById('edit_exam_time').value = exam.exam_time;
                document.getElementById('edit_reg_start_date').value = formatDateTimeForInput(exam.reg_start_date);
                document.getElementById('edit_reg_end_date').value = formatDateTimeForInput(exam.reg_end_date);
                document.getElementById('edit_batch_year').value = exam.batch_year;
                
                document.getElementById('edit-exam-modal').classList.add('active');
            } catch (error) {
                showMessage('Error fetching exam details: ' + error.message, 'error');
            }
        }
        window.openEditExamModal = openEditExamModal;

        function closeEditExamModal() {
            document.getElementById('edit-exam-modal').classList.remove('active');
        }
        window.closeEditExamModal = closeEditExamModal;

        /**
         * Handles the update exam form submission
         * @param {Event} e - The form submit event
         */
        async function handleUpdateExamSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const examData = Object.fromEntries(formData.entries());
            const examId = document.getElementById('edit-exam-id').value; // Get ID from hidden field
            
            try {
                const { error } = await supabase
                    .from('exams')
                    .update(examData)
                    .eq('id', examId);
                
                if (error) throw error;
                
                showMessage('Exam updated successfully!', 'success');
                closeEditExamModal();
                loadAdminData(); // Refresh exam list
                loadExams(); // Refresh home page
            } catch (error) {
                showMessage('Error updating exam: ' + error.message, 'error');
            }
        }
        
        /**
         * Deletes an exam (and all related registrations/results)
         * @param {number} examId - The ID of the exam to delete
         */
        async function handleDeleteExam(examId) {
            if (!confirm('Are you sure you want to delete this exam? This will also delete all registrations and results associated with it. This action cannot be undone.')) {
                return;
            }
            
            try {
                // Supabase is set up with cascading deletes,
                // so we only need to delete from the 'exams' table.
                const { error } = await supabase
                    .from('exams')
                    .delete()
                    .eq('id', examId);
                
                if (error) throw error;
                
                showMessage('Exam deleted successfully!', 'success');
                loadAdminData(); // Refresh list
                loadExams(); // Refresh home page
            } catch (error) {
                console.error('Error deleting exam:', error.message);
                showMessage('Error deleting exam: ' + error.message, 'error');
            }
        }
        window.handleDeleteExam = handleDeleteExam;

        /**
         * Publishes exam results, calculates ranks
         * @param {number} examId - The ID of the exam to publish
         */
        async function handlePublishResults(examId) {
            if (!confirm('Are you sure you want to publish (or republish) results for this exam? This will calculate and set ranks for all present students with marks.')) {
                return;
            }
            
            try {
                // 1. Fetch all registrations and results for this exam
                const { data: regs, error: fetchError } = await supabase
                    .from('registrations')
                    .select(`
                        id,
                        is_present,
                        results (
                            id,
                            marks,
                            is_absent
                        )
                    `)
                    .eq('exam_id', examId);
                
                if (fetchError) throw fetchError;
                
                // 2. Process data: Determine final status and filter for ranking
                let resultsToUpsert = [];

                // Filter students eligible for ranking: NOT Absent AND NOT Null Marks
                const studentsForRanking = regs
                    .filter(reg => {
                        const result = reg.results[0];
                        // Auto-create a result if none exists, marking as absent if not present
                        if (!result) {
                            resultsToUpsert.push({
                                registration_id: reg.id,
                                marks: null,
                                is_absent: !reg.is_present, // Absent if not checked-in
                                rank: null
                            });
                            return false; // Not eligible for ranking yet
                        }
                        
                        // Students are eligible for ranking if they have marks and are not absent
                        const eligible = result.marks !== null && result.is_absent === false;
                        
                        // If result exists but is absent/null marks, prepare to reset rank to null
                        if (!eligible) {
                             resultsToUpsert.push({
                                id: result.id,
                                registration_id: reg.id,
                                marks: result.marks,
                                is_absent: result.is_absent,
                                rank: null // Clear rank
                            });
                        }

                        return eligible;
                    })
                    // Map to simpler object for sorting
                    .map(reg => ({
                        reg_id: reg.id,
                        result_id: reg.results[0].id,
                        marks: reg.results[0].marks
                    }));
                    
                // Sort students for ranking (descending marks)
                studentsForRanking.sort((a, b) => b.marks - a.marks);
                    
                // 3. Calculate ranks for eligible students
                let rank = 1;
                for (let i = 0; i < studentsForRanking.length; i++) {
                    // Check for ties with the previous student
                    if (i > 0 && studentsForRanking[i].marks < studentsForRanking[i-1].marks) {
                        rank = i + 1;
                    }
                    resultsToUpsert.push({
                        id: studentsForRanking[i].result_id,
                        registration_id: studentsForRanking[i].reg_id,
                        marks: studentsForRanking[i].marks,
                        is_absent: false,
                        rank: rank
                    });
                }
                
                // 4. Batch update the results table
                if (resultsToUpsert.length > 0) {
                    const { error: updateError } = await supabase
                        .from('results')
                        .upsert(resultsToUpsert, { onConflict: 'registration_id' }); // Use registration_id as unique constraint
                    
                    if (updateError) throw updateError;
                }

                // 5. Mark the exam as published
                const { error: publishError } = await supabase
                    .from('exams')
                    .update({ is_published: true })
                    .eq('id', examId);
                
                if (publishError) throw publishError;
                
                showMessage('Results published and ranks calculated successfully!', 'success');
                loadAdminData(); // Refresh list
            } catch (error) {
                console.error('Error publishing results:', error.message);
                showMessage('Error publishing results: ' + error.message, 'error');
            }
        }
        window.handlePublishResults = handlePublishResults;
        
        /**
         * Unpublishes exam results
         * @param {number} examId - The ID of the exam to unpublish
         */
        async function handleUnpublishResults(examId) {
            if (!confirm('Are you sure you want to unpublish this exam? Students will no longer be able to see their results.')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('exams')
                    .update({ is_published: false })
                    .eq('id', examId);
                
                if (error) throw error;
                
                showMessage('Exam unpublished successfully!', 'success');
                loadAdminData(); // Refresh list
            } catch (error) {
                showMessage('Error unpublishing exam: ' + error.message, 'error');
            }
        }
        window.handleUnpublishResults = handleUnpublishResults;

        // --- Admin: Student Check-in ---

        /**
         * Loads exams for the Check-in select dropdown
         */
        async function loadCheckInExams() {
            // This is handled by loadAdminData() which is called on page-admin activation
        }

        /**
         * Handles the student check-in form submission
         * @param {Event} e - The form submit event
         */
        async function handleCheckIn(e) {
            e.preventDefault();
            const checkInExamId = document.getElementById('check-in-exam-select').value;
            const indexNumber = document.getElementById('check_in_index_number').value.trim();
            const statusDiv = document.getElementById('check-in-status');
            
            statusDiv.innerHTML = '';
            statusDiv.classList.add('hidden');

            if (!checkInExamId) {
                showMessage('Please select an exam first.', 'error');
                return;
            }
            if (!indexNumber) {
                showMessage('Please enter an index number or scan a QR code.', 'error');
                return;
            }

            try {
                // 1. Find the registration
                const { data: registration, error: regError } = await supabase
                    .from('registrations')
                    .select('id, student_name, is_present')
                    .eq('exam_id', checkInExamId)
                    .eq('index_number', indexNumber)
                    .single();
                
                if (regError || !registration) {
                    throw new Error('Index Number not registered for this exam.');
                }

                // 2. Check if already present
                if (registration.is_present) {
                    statusDiv.innerHTML = `&#9888; ${registration.student_name} (Index: ${indexNumber}) is **already checked in** for this exam.`;
                    statusDiv.className = 'mt-6 p-4 rounded-lg text-center font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
                    statusDiv.classList.remove('hidden');
                    return;
                }
                
                // 3. Update 'is_present' to true
                const { error: updateError } = await supabase
                    .from('registrations')
                    .update({ is_present: true })
                    .eq('id', registration.id);

                if (updateError) throw updateError;
                
                statusDiv.innerHTML = `&#9989; Check-in Successful! **${registration.student_name}** (Index: ${indexNumber}) is marked as **Present**.`;
                statusDiv.className = 'mt-6 p-4 rounded-lg text-center font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
                statusDiv.classList.remove('hidden');
                document.getElementById('check_in_index_number').value = ''; // Clear input for next scan

            } catch (error) {
                console.error('Check-in error:', error.message);
                statusDiv.innerHTML = `&#10060; Check-in Failed: ${error.message}`;
                statusDiv.className = 'mt-6 p-4 rounded-lg text-center font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
                statusDiv.classList.remove('hidden');
            }
        }

        // --- Admin: Manage Marks ---

        /**
         * Loads all students and their marks for a selected exam
         * @param {string} examId - The ID of the selected exam
         */
        async function loadStudentsForMarking(examId) {
            const container = document.getElementById('mark-student-list');
            if (!examId) {
                container.innerHTML = '';
                currentMarkData = [];
                return;
            }
            
            container.innerHTML = '<p class="text-gray-600 dark:text-gray-400">Loading student marks...</p>';
            
            try {
                // Fetch registrations AND their results (use left join by removing '!inner')
                const { data, error } = await supabase
                    .from('registrations')
                    .select(`
                        id,
                        student_name,
                        index_number,
                        is_present,
                        results (
                            id,
                            marks,
                            is_absent
                        )
                    `)
                    .eq('exam_id', examId)
                    .order('student_name', { ascending: true }); // Order by name
                
                if (error) throw error;
                
                // Process data for easier use
                currentMarkData = data.map(reg => {
                    const result = reg.results[0] || null;
                    return {
                        reg_id: reg.id,
                        student_name: reg.student_name,
                        index_number: reg.index_number,
                        is_present_status: reg.is_present, // New attendance status
                        result_id: result ? result.id : null,
                        marks: result ? result.marks : null,
                        is_absent: result ? result.is_absent : !reg.is_present // Default to absent if no result and not checked-in
                    };
                });
                
                renderStudentMarkList();

            } catch (error) {
                showMessage('Error loading student marks: ' + error.message, 'error');
                container.innerHTML = '<p class="text-red-500">Error loading data.</p>';
            }
        }
        window.loadStudentsForMarking = loadStudentsForMarking;
        
        /**
         * Renders the table of students and their marks
         */
        function renderStudentMarkList() {
            const container = document.getElementById('mark-student-list');
            if (currentMarkData.length === 0) {
                container.innerHTML = '<p class="text-gray-600 dark:text-gray-400">No students registered for this exam yet.</p>';
                return;
            }
            
            let tableHTML = `
                <table class="w-full min-w-max text-left mt-4">
                    <thead class="bg-gray-100 dark:bg-gray-700">
                        <tr>
                            <th class="p-3 font-semibold">Name</th>
                            <th class="p-3 font-semibold">Index #</th>
                            <th class="p-3 font-semibold">Marks</th>
                            <th class="p-3 font-semibold">Attendance</th>
                            <th class="p-3 font-semibold">Status</th>
                            <th class="p-3 font-semibold">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            currentMarkData.forEach(student => {
                let status, statusClass;
                let attendanceStatus, attendanceClass;

                // Attendance Status
                if (student.is_present_status) {
                    attendanceStatus = 'Present';
                    attendanceClass = 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
                } else {
                    attendanceStatus = 'Absent';
                    attendanceClass = 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
                }

                // Marks Status
                if (student.is_absent) {
                    status = 'Absent';
                    statusClass = 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
                } else if (student.marks !== null) {
                    status = 'Marked';
                    statusClass = 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';
                } else {
                    status = 'Pending';
                    statusClass = 'bg-gray-100 text-gray-800 dark:bg-gray-600 dark:text-gray-200';
                }
                
                tableHTML += `
                    <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                        <td class="p-3">${student.student_name}</td>
                        <td class="p-3">${student.index_number}</td>
                        <td class="p-3">${student.marks !== null ? student.marks : 'N/A'}</td>
                        <td class="p-3"><span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${attendanceClass}">${attendanceStatus}</span></td>
                        <td class="p-3"><span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${statusClass}">${status}</span></td>
                        <td class="p-3 flex gap-2 flex-wrap"> <button onclick="editMark('${student.index_number}')" class="text-sm bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md shadow-sm">Edit Mark</button>
                            ${student.result_id ? `<button onclick="handleDeleteMark(${student.result_id})" class="text-sm bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md shadow-sm">Delete Mark</button>` : ''}
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
        }

        /**
         * Deletes a specific mark entry
         * @param {number} resultId - The ID of the result entry to delete
         */
        async function handleDeleteMark(resultId) {
            if (!confirm('Are you sure you want to delete this mark entry? The student will revert to "Pending" status.')) {
                return;
            }
            try {
                const { error } = await supabase
                    .from('results')
                    .delete()
                    .eq('id', resultId);
                
                if (error) throw error;
                
                showMessage('Mark deleted successfully!', 'success');
                loadStudentsForMarking(document.getElementById('mark-exam-select').value); // Refresh list
            } catch (error) {
                showMessage('Error deleting mark: ' + error.message, 'error');
            }
        }
        window.handleDeleteMark = handleDeleteMark;

        /**
         * Pre-fills the mark entry form for editing
         * @param {string} indexNumber - The index number of the student to edit
         */
        function editMark(indexNumber) {
            const student = currentMarkData.find(s => s.index_number === indexNumber);
            if (!student) return;
            
            document.getElementById('index_number').value = student.index_number;
            document.getElementById('marks').value = student.marks;
            document.getElementById('absent').checked = student.is_absent;
            
            // Disable/enable marks based on absent
            document.getElementById('marks').disabled = student.is_absent;
            
            // Scroll to form
            document.getElementById('add-mark-form').scrollIntoView({ behavior: 'smooth' });
        }
        window.editMark = editMark;

        /**
         * Handles Add/Update Mark form submission
         * @param {Event} e - The form submit event
         */
        async function handleAddMarkSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const markData = Object.fromEntries(formData.entries());
            
            const examId = document.getElementById('mark-exam-select').value;
            if (!examId) {
                showMessage('Please select an exam first.', 'error');
                return;
            }
            
            const isAbsent = formData.has('absent');
            const marks = isAbsent ? null : parseFloat(markData.marks);
            
            try {
                // 1. Find the registration data for this index number and exam
                const { data: registration, error: regError } = await supabase
                    .from('registrations')
                    .select('id, is_present')
                    .eq('exam_id', examId)
                    .eq('index_number', markData.index_number)
                    .single();
                
                if (regError || !registration) {
                    throw new Error('Invalid Index Number for this exam.');
                }
                
                const registrationId = registration.id;
                
                // 2. Check if a result entry already exists
                const { data: existingResult, error: checkError } = await supabase
                    .from('results')
                    .select('id')
                    .eq('registration_id', registrationId)
                    .maybeSingle(); // Use maybeSingle to prevent error on no rows

                if (checkError && checkError.code !== 'PGRST116') { // PGRST116 = no rows found
                    throw checkError;
                }
                
                // 3. Upsert (Insert or Update) the result
                // NOTE: Removed exam_id from upsert data as per SQL schema change
                const { error: upsertError } = await supabase
                    .from('results')
                    .upsert({
                        id: existingResult ? existingResult.id : undefined, // Provide ID for update
                        registration_id: registrationId,
                        marks: marks,
                        is_absent: isAbsent,
                        rank: null // Rank will be set on publish
                    }, {
                        onConflict: 'registration_id' // Unique constraint on registration_id
                    });
                
                if (upsertError) throw upsertError;
                
                showMessage('Mark added/updated successfully!', 'success');
                form.reset();
                loadStudentsForMarking(examId); // Refresh the list
                
            } catch (error) {
                console.error('Error adding mark:', error.message);
                showMessage('Error adding mark: ' + error.message, 'error');
            }
        }
        
        // --- Admin: Manage Students ---

        /**
         * Loads all students for a selected exam
         * @param {string} examId - The ID of the selected exam
         */
        async function loadStudentsForManagement(examId) {
            const container = document.getElementById('student-management-list');
            if (!examId) {
                container.innerHTML = '<p class="text-gray-600 dark:text-gray-400">Select an exam to see registered students.</p>';
                currentStudentData = [];
                return;
            }
            
            container.innerHTML = '<p class="text-gray-600 dark:text-gray-400">Loading students...</p>';
            
            try {
                const { data, error } = await supabase
                    .from('registrations')
                    .select('*')
                    .eq('exam_id', examId)
                    .order('student_name', { ascending: true }); // Order by name
                
                if (error) throw error;
                
                currentStudentData = data;
                renderStudentManagementList();

            } catch (error) {
                showMessage('Error loading students: ' + error.message, 'error');
                container.innerHTML = '<p class="text-red-500">Error loading data.</p>';
            }
        }
        window.loadStudentsForManagement = loadStudentsForManagement;
        
        /**
         * Renders the student management table based on search query
         */
        function renderStudentManagementList() {
            const container = document.getElementById('student-management-list');
            const query = document.getElementById('student-search-input').value.toLowerCase();
            
            const filteredStudents = currentStudentData.filter(student => {
                return (
                    student.student_name.toLowerCase().includes(query) ||
                    student.nic.toLowerCase().includes(query) ||
                    (student.email && student.email.toLowerCase().includes(query)) ||
                    student.index_number.toLowerCase().includes(query)
                );
            });
            
            if (filteredStudents.length === 0) {
                container.innerHTML = '<p class="text-gray-600 dark:text-gray-400">No students found matching your search.</p>';
                return;
            }
            
            let tableHTML = `
                <table class="w-full min-w-max text-left">
                    <thead class="bg-gray-100 dark:bg-gray-700">
                        <tr>
                            <th class="p-3 font-semibold">Name</th>
                            <th class="p-3 font-semibold">Index #</th>
                            <th class="p-3 font-semibold">NIC</th>
                            <th class="p-3 font-semibold">Email</th>
                            <th class="p-3 font-semibold">Phone</th>
                            <th class="p-3 font-semibold">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filteredStudents.forEach(student => {
                tableHTML += `
                    <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                        <td class="p-3">${student.student_name}</td>
                        <td class="p-3">${student.index_number}</td>
                        <td class="p-3">${student.nic}</td>
                        <td classD="p-3">${student.email || 'N/A'}</td>
                        <td class="p-3">${student.phone || 'N/A'}</td>
                        <td class="p-3 flex gap-2 flex-wrap"> <button onclick="openEditStudentModal(${student.id})" class="text-sm bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md shadow-sm">Edit</button>
                            <button onclick="handleDeleteRegistration(${student.id})" class="text-sm bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md shadow-sm">Delete</button>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
        }

        /**
         * Deletes a student registration
         * @param {number} registrationId - The ID of the registration to delete
         */
        async function handleDeleteRegistration(registrationId) {
            if (!confirm('Are you sure you want to delete this student registration? This will also delete their marks. This action cannot be undone.')) {
                return;
            }
            try {
                // Cascading delete in Supabase should handle the 'results' entry
                const { error } = await supabase
                    .from('registrations')
                    .delete()
                    .eq('id', registrationId);
                
                if (error) throw error;
                
                showMessage('Registration deleted successfully!', 'success');
                loadStudentsForManagement(document.getElementById('student-exam-select').value); // Refresh list
            } catch (error) {
                showMessage('Error deleting registration: ' + error.message, 'error');
            }
        }
        window.handleDeleteRegistration = handleDeleteRegistration;

        /**
         * Handles live search input for student management
         */
        function handleStudentSearch() {
            renderStudentManagementList();
        }
        window.handleStudentSearch = handleStudentSearch;

        /**
         * Opens the edit student modal
         * @param {number} studentId - The registration ID of the student
         */
        function openEditStudentModal(studentId) {
            const student = currentStudentData.find(s => s.id === studentId);
            if (!student) return;
            
            document.getElementById('edit-student-id').value = student.id;
            document.getElementById('edit_student_name').value = student.student_name;
            document.getElementById('edit_nic').value = student.nic;
            document.getElementById('edit_email').value = student.email;
            document.getElementById('edit_phone').value = student.phone;
            
            document.getElementById('edit-student-modal').classList.add('active');
        }
        window.openEditStudentModal = openEditStudentModal;

        function closeEditStudentModal() {
            document.getElementById('edit-student-modal').classList.remove('active');
        }
        window.closeEditStudentModal = closeEditStudentModal;
        
        /**
         * Handles update student form submission
         * @param {Event} e - The form submit event
         */
        async function handleUpdateStudentSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const studentId = document.getElementById('edit-student-id').value; // Get ID from hidden field

            const studentData = {
                student_name: document.getElementById('edit_student_name').value,
                nic: document.getElementById('edit_nic').value,
                email: document.getElementById('edit_email').value,
                phone: document.getElementById('edit_phone').value
            };
            
            try {
                const { error } = await supabase
                    .from('registrations')
                    .update(studentData)
                    .eq('id', studentId);
                
                if (error) throw error;
                
                showMessage('Student updated successfully!', 'success');
                closeEditStudentModal();
                loadStudentsForManagement(document.getElementById('student-exam-select').value); // Refresh list
            } catch (error) {
                showMessage('Error updating student: ' + error.message, 'error');
            }
        }
        
        // --- Results Page (result.html) ---

        /**
         * Loads all PUBLISHED exams into the results dropdown
         */
        async function loadPublishedExams() {
            try {
                const { data, error } = await supabase
                    .from('exams')
                    .select('id, name, batch_year')
                    .eq('is_published', true)
                    .order('exam_date', { ascending: false });
                
                if (error) throw error;
                
                const select = document.getElementById('result-exam-select');
                select.innerHTML = '<option value="">-- Select an Exam --</option>'; // Reset
                data.forEach(exam => {
                    select.innerHTML += `<option value="${exam.id}">${exam.name} (${exam.batch_year})</option>`;
                });

            } catch (error) {
                console.error('Error loading published exams:', error.message);
            }
        }
        
        /**
         * Calculates the grade based on marks
         * @param {number|null} marks - The student's marks
         * @param {boolean} isAbsent - If the student was absent
         * @returns {string} - The calculated grade (A, B, C, S, W, ab)
         */
        function getGrade(marks, isAbsent) {
            if (isAbsent) return 'AB';
            if (marks === null || marks === undefined) return 'N/A';
            if (marks >= 75) return 'A';
            if (marks >= 65) return 'B';
            if (marks >= 55) return 'C';
            if (marks >= 35) return 'S';
            return 'W';
        }
        
        /**
         * Handles the check result form submission
         * @param {Event} e - The form submit event
         */
        async function handleCheckResultSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const examId = form['result-exam-select'].value;
            const indexNumber = form['result-index-number'].value.trim();
            const resultWrapper = document.getElementById('result-display-wrapper');
            
            if (!examId || !indexNumber) {
                showMessage('Please select an exam and enter your index number.', 'error');
                return;
            }
            
            resultWrapper.innerHTML = `<p class="text-center text-gray-600 dark:text-gray-400">Checking...</p>`;
            
            try {
                // 1. Get the exam, registration, and result data in one go
                const { data, error } = await supabase
                    .from('registrations')
                    .select(`
                        student_name,
                        index_number,
                        exam:exams!inner (
                            name,
                            exam_date
                        ),
                        results!inner (
                            marks,
                            is_absent,
                            rank
                        )
                    `)
                    .eq('exam_id', examId)
                    .eq('index_number', indexNumber)
                    .eq('exams.is_published', true)
                    .single();

                if (error) {
                    if (error.code === 'PGRST116') { // No rows found
                        throw new Error('Result not found. Please check your exam selection and index number, or the result may not be published.');
                    }
                    throw error;
                }
                
                // 2. Populate the template
                const template = document.getElementById('result-pdf-template').innerHTML;
                resultWrapper.innerHTML = template;
                
                const resultData = data.results[0]; // Result is an array
                
                document.getElementById('pdf-exam-name').innerText = `${data.exam.name}`;
                document.getElementById('pdf-exam-date').innerText = new Date(data.exam.exam_date).toLocaleDateString('en-US');
                document.getElementById('pdf-student-name').innerText = data.student_name;
                document.getElementById('pdf-index-number').innerText = data.index_number;
                
                const grade = getGrade(resultData.marks, resultData.is_absent);
                
                document.getElementById('pdf-marks').innerText = resultData.is_absent ? 'ABSENT' : (resultData.marks !== null ? `${resultData.marks}%` : 'N/A');
                document.getElementById('pdf-grade').innerText = grade;
                document.getElementById('pdf-rank').innerText = resultData.rank ? `Island Rank: ${resultData.rank}` : (resultData.is_absent ? '' : 'Rank: N/A');
                
                if (resultData.is_absent || resultData.marks === null) {
                    document.getElementById('pdf-marks').classList.add('text-5xl');
                    document.getElementById('pdf-marks').classList.remove('text-7xl');
                } else {
                    document.getElementById('pdf-marks').classList.add('text-7xl');
                    document.getElementById('pdf-marks').classList.remove('text-5xl');
                }

            } catch (error) {
                console.error('Error checking result:', error.message);
                showMessage(error.message, 'error');
                resultWrapper.innerHTML = `<p class="text-center text-red-500">${error.message}</p>`;
            }
        }
        
        // --- Leaderboards (Public & Admin) ---

        // --- Leaderboards (Public & Admin) ---

/**
 * Shows the leaderboard (Top 10 or All)
 * @param {string} type - 'top10' or 'all'
 * @param {string} context - 'public' or 'admin'
 */
async function handleViewLeaderboard(type, context) {
    let examId;
    if (context === 'public') {
        examId = document.getElementById('result-exam-select').value;
    } else {
        examId = document.getElementById('rank-exam-select-admin').value;
    }
    
    if (!examId) {
        showMessage('Please select an exam first.', 'error');
        return;
    }
    
    // Fetch exam details to check published status and get name
    let exam = currentExamData[examId];
    if (!exam) {
        const { data: fetchedExam, error } = await supabase.from('exams').select('name, batch_year, is_published').eq('id', examId).single();
        if (error || !fetchedExam) {
            showMessage('Could not find exam details.', 'error');
            return;
        }
        exam = fetchedExam;
        currentExamData[examId] = exam;
    }

    // Check if published
    if (context === 'public' && !exam.is_published) {
        showMessage('The results for this exam have not been published yet.', 'error');
        return;
    }
    
    const examName = `${exam.name} (${exam.batch_year})`;
    
    const modal = document.getElementById('leaderboard-modal');
    const title = document.getElementById('leaderboard-title');
    const content = document.getElementById('leaderboard-content');
    
    title.innerText = `${type === 'top10' ? 'Top 10' : 'Full'} Leaderboard - ${examName}`;
    content.innerHTML = '<p class="text-gray-600 dark:text-gray-400">Loading ranks...</p>';
    modal.classList.add('active');
    
    try {
        let query = supabase
            .from('results')
            .select(`
                marks,
                rank,
                registrations:registrations!inner (
                    student_name,
                    exam_id 
                )
            `)
            .not('rank', 'is', null) // Only select students with a calculated rank
            // THE CRITICAL FIX IS HERE: Filter registrations based on exam_id
            .filter('registrations.exam_id', 'eq', examId) // <--- FIX APPLIED
            .order('rank', { ascending: true })
            .order('marks', { ascending: false });
        
        if (type === 'top10') {
            query = query.limit(10);
        }
        
        const { data: results, error } = await query;
        
        if (error) throw error;
        
        if (results.length === 0) {
            content.innerHTML = '<p class="text-gray-600 dark:text-gray-400">No ranked results found for this exam. Ensure results are published.</p>';
            return;
        }
        
        // ... (rest of the display logic is the same)
        let tableHTML = `
            <table class="w-full text-left">
                <thead class="bg-gray-100 dark:bg-gray-700">
                    <tr>
                        <th class="p-3 font-semibold">Rank</th>
                        <th class="p-3 font-semibold">Name</th>
                        <th class="p-3 font-semibold">Marks</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        results.forEach(res => {
            const studentName = res.registrations ? res.registrations.student_name : 'Unknown Student';
            tableHTML += `
                <tr class="border-b dark:border-gray-700">
                    <td class="p-3 font-bold">${res.rank}</td>
                    <td class="p-3">${studentName}</td>
                    <td class="p-3">${res.marks}%</td>
                </tr>
            `;
        });
        
        tableHTML += `</tbody></table>`;
        content.innerHTML = tableHTML;
        
        // Set up PDF download button
        document.getElementById('download-leaderboard-pdf').onclick = () => {
            downloadLeaderboardPDF(examName, type, results);
        };

    } catch (error) {
        showMessage('Error loading leaderboard: ' + error.message, 'error');
        content.innerHTML = '<p class="text-red-500">Error loading data.</p>';
    }
}
window.handleViewLeaderboard = handleViewLeaderboard;

// ... (rest of the file)

        function closeLeaderboardModal() {
            document.getElementById('leaderboard-modal').classList.remove('active');
        }
        window.closeLeaderboardModal = closeLeaderboardModal;

        /**
         * Generates a PDF of the leaderboard
         * @param {string} examName - The name of the exam
         * @param {string} type - 'top10' or 'all'
         * @param {Array} results - The array of result data
         */
        function downloadLeaderboardPDF(examName, type, results) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(20);
            doc.text("DE Education.lk", 105, 20, { align: 'center' });
            
            doc.setFontSize(16);
            doc.setFont('helvetica', 'normal');
            doc.text(`${type === 'top10' ? 'Top 10' : 'Full'} Leaderboard`, 105, 30, { align: 'center' });
            
            doc.setFontSize(14);
            doc.text(examName, 105, 40, { align: 'center' });

            const tableBody = results.map(res => [
                res.rank,
                res.registrations ? res.registrations.student_name : 'Unknown', // Safety check
                `${res.marks}%`
            ]);

            doc.autoTable({
                head: [['Rank', 'Name', 'Marks']],
                body: tableBody,
                startY: 50,
                headStyles: {
                    fillColor: [30, 58, 138] // Dark Blue
                }
            });

            doc.save(`Leaderboard_${examName.replace(/ /g, '_')}.pdf`);
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // Dark Mode Setup (Fix)
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            // Set checkbox state on load
            if (document.documentElement.classList.contains('dark')) {
                darkModeToggle.checked = true;
            }
            // Attach listener
            darkModeToggle.addEventListener('change', toggleDarkMode);

            // Admin nav tabs
            document.querySelectorAll('#admin-nav a.admin-nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    showAdminTab(this.dataset.tab);
                });
            });

            // Form Submissions
            document.getElementById('admin-login-form').addEventListener('submit', handleAdminLogin);
            document.getElementById('create-exam-form').addEventListener('submit', handleCreateExamSubmit);
            document.getElementById('edit-exam-form').addEventListener('submit', handleUpdateExamSubmit);
            document.getElementById('registration-form').addEventListener('submit', handleRegistrationSubmit);
            document.getElementById('add-mark-form').addEventListener('submit', handleAddMarkSubmit);
            document.getElementById('check-result-form').addEventListener('submit', handleCheckResultSubmit);
            document.getElementById('edit-student-form').addEventListener('submit', handleUpdateStudentSubmit);
            document.getElementById('check-in-form').addEventListener('submit', handleCheckIn); // NEW: Check-in form

            
            // Handle absent checkbox logic
            document.getElementById('absent').addEventListener('change', function() {
                document.getElementById('marks').disabled = this.checked;
                if (this.checked) {
                    document.getElementById('marks').value = '';
                }
            });
            
            // Close modals
            window.onclick = function(event) {
                const editStudentModal = document.getElementById('edit-student-modal');
                const editExamModal = document.getElementById('edit-exam-modal');
                const leaderboardModal = document.getElementById('leaderboard-modal');
                if (event.target == editStudentModal) {
                    closeEditStudentModal();
                }
                if (event.target == editExamModal) {
                    closeEditExamModal();
                }
                if (event.target == leaderboardModal) {
                    closeLeaderboardModal();
                }
            }
            
            // Fade out preloader
            const preloader = document.getElementById('preloader');
            if (preloader) {
                setTimeout(() => {
                    preloader.style.opacity = '0';
                    setTimeout(() => preloader.style.display = 'none', 1000); // Hide after fade
                }, 500); // Minimum load time
            }

            // Load initial data for home page
            loadExams();
        });
    </script>
</body>
</html>
